# Architecture Overview - OMCP R Sandbox

This document describes the high-level architecture of the OMCP R Sandbox, focusing on the stateful session model using Rserve.

## System Overview

The OMCP R Sandbox provides a secure, stateful environment for executing R code via the Model Context Protocol (MCP). Unlike simple "execute-and-forget" sandboxes, it maintains persistent R environments (sessions) that allow for iterative analysis, which is critical for complex OHDSI/DARWIN workflows.

## Key Components

- **FastMCP Server** (`src/omcp_r/main.py`): The core service that exposes MCP tools for session management, code execution, and file I/O.
- **Session Manager** (`src/omcp_r/sandbox_manager.py`): A Python component that manages the lifecycle of Docker containers and communicates with them via the Rserve protocol.
- **R Sandbox Container**: A specialized Docker container running **Rserve**. Each session gets its own isolated container.
- **Configuration System** (`src/omcp_r/config.py`): Centralized management of environment-based settings.

## Component Interactions

```mermaid
graph TD;
  Client["MCP Client (e.g., AI Agent)"] -->|MCP Request| FastMCP["FastMCP Server"]
  FastMCP -->|Manage Sessions| SessionManager["Session Manager"]
  SessionManager -->|Docker API| Docker["Docker Daemon"]
  SessionManager -->|pyRserve (TCP)| RContainer["R Sandbox (Rserve)"]
  Docker -->|Spawn| RContainer
```

## Session Lifecycle

1. **Create Session**: `SessionManager` requests the Docker Daemon to start a container from the specialized `omcp-r-sandbox` image. Docker maps the container's Rserve port (6311) to a random host port.
2. **Execute Code**: `SessionManager` uses `pyRserve` to connect to the mapped host port and evaluate R code inside the container. State (variables, loaded libraries) is maintained as long as the container is running.
3. **File I/O**: The server uses Docker's archive API to securely move files between the host and the container. This allows uploading JSON cohort definitions or downloading CSV results.
4. **Cleanup**: Sessions are automatically closed based on inactivity (timeout) or an explicit `close_session` request. Containers are removed (`--remove`) upon stopping.

## Network and Communication

- **Rserve Implementation**: The sandbox uses Rserve to allow persistent state. The Python bridge (`pyRserve`) communicates with Rserve over a dynamically assigned TCP port.
- **Dynamic Port Mapping**: To prevent conflicts between multiple sessions, the system relies on Docker to assign ephemeral ports on the host.

## Specialization: OMOP/DARWIN

The architecture is specifically tailored for health data sciences:
- **JDBC Ready**: Containers include Java 17, allowing packages like `DatabaseConnector` to connect to external OMOP repositories.
- **Artifact Retrieval**: The file management tools are designed to pull large analysis results (CSVs, figures) generated by DARWIN tools.

---

For implementation details, see [Implementation Details](implementation.md).